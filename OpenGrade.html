<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenGrade — Minimal Teacher Gradebook</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22c55e; /* green-500 */
      --accent-2:#3b82f6; /* blue-500 */
      --warn:#f59e0b; /* amber-500 */
      --danger:#ef4444; /* red-500 */
      --card:#0b1220;
      --border:#1f2937; /* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1020 0%, #0a0f1a 100%);
      color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Noto Sans, Arial, 'Apple Color Emoji','Segoe UI Emoji';
    }
    header{
      position:sticky; top:0; z-index:3;
      background:rgba(12,18,32,.9); backdrop-filter:saturate(120%) blur(8px);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:16px; padding:12px 16px;
    }
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .actions{margin-left:auto; display:flex; flex-wrap:wrap; gap:8px}
    button, .btn{
      background:linear-gradient(180deg,#1d2a44,#111a2c);
      color:#e8f0ff; border:1px solid #1f2b45; border-radius:10px;
      padding:8px 12px; font-weight:600; cursor:pointer;
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.35)}
    button.primary{background:linear-gradient(180deg,#1a3a2a,#10291d); border-color:#1e3a2a}
    button.accent{background:linear-gradient(180deg,#12335d,#0f2748); border-color:#17365e}
    button.warn{background:linear-gradient(180deg,#5a3b12,#3d280b); border-color:#6b400e}
    .app{display:grid; grid-template-columns:260px 1fr; height:calc(100% - 58px)}
    aside{
      border-right:1px solid var(--border); padding:14px; overflow:auto; background:linear-gradient(180deg,#0a1222,#0a111b);
    }
    .section-title{font-size:12px; letter-spacing:.5px; text-transform:uppercase; color:var(--muted); margin:8px 0}
    .class-list{display:flex; flex-direction:column; gap:8px}
    .class-item{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px; cursor:pointer;
      background:linear-gradient(180deg,#0d1626,#0b1220);
    }
    .class-item.active{outline:1px solid #3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .class-item .name{font-weight:600}
    main{padding:16px; overflow:auto}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    .toolbar .spacer{flex:1}
    .card{background:linear-gradient(180deg,#0c1426,#0a111e); border:1px solid var(--border); border-radius:14px; padding:12px}
    .grid{width:100%; border-collapse:separate; border-spacing:0; min-width:720px}
    .grid th, .grid td{border-bottom:1px solid #1b2538}
    .grid thead th{position:sticky; top:0; background:#0b1220; z-index:2}
    .grid th, .grid td{padding:10px; text-align:left}
    .grid tbody tr:hover{background:#0d1526}
    .grid th:first-child, .grid td:first-child{position:sticky; left:0; background:#0b1220; z-index:1}
    .tag{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    input[type="number"]{
      width:92px; padding:6px 8px; border-radius:8px; border:1px solid #22304a; background:#0c1526; color:var(--text);
    }
    input[type="text"], input[type="date"]{
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid #22304a; background:#0c1526; color:var(--text);
    }
    .pill { padding:4px 8px; border-radius:999px; font-weight:700 }
    .A{background:#123b22} .B{background:#1a2f55} .C{background:#4a3412} .D{background:#4a1b12} .F{background:#3a0f0f}
    .muted{color:var(--muted)}
    .footer{margin-top:12px; font-size:12px; color:var(--muted)}
    .row-actions{display:flex; gap:6px}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    @media (max-width: 980px){ .app{grid-template-columns: 1fr} aside{order:2} }
  </style>
</head>
<body>
  <header>
    <h1>📘 OpenGrade <span class="muted">— Minimal Teacher Gradebook</span></h1>
    <div class="actions">
      <button id="btn-add-class" class="accent">+ Class</button>
      <button id="btn-export-csv">Export CSV</button>
      <button id="btn-save-json">Download JSON</button>
      <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
        <input id="import-json" type="file" accept="application/json" class="sr-only">Import JSON
      </label>
      <button id="btn-reset" class="warn">Reset</button>
    </div>
  </header>
  <div class="app">
    <aside>
      <div class="section-title">Classes</div>
      <div id="classList" class="class-list"></div>
      <div class="section-title">Selected</div>
      <div id="selectedMeta" class="card"></div>
      <div class="section-title">Roster</div>
      <div class="card">
        <div style="display:flex; gap:8px; margin-bottom:10px">
          <input id="studentName" type="text" placeholder="Student full name" />
          <button id="btn-add-student" class="primary">+ Student</button>
        </div>
        <div id="studentCount" class="muted"></div>
      </div>
      <div class="section-title">Weeks</div>
      <div class="card">
        <div style="display:grid; grid-template-columns:1fr 130px; gap:8px; margin-bottom:10px">
          <input id="weekLabel" type="text" placeholder="e.g., Week 1" />
          <input id="weekDate" type="date" />
        </div>
        <button id="btn-add-week">+ Week</button>
        <div id="weekCount" class="muted" style="margin-top:8px"></div>
      </div>
    </aside>
    <main>
      <div class="toolbar">
        <div class="tag" id="gradeScale">Scale: A ≥90, B ≥80, C ≥70, D ≥60</div>
        <div class="spacer"></div>
        <button id="btn-add-week-top">+ Week</button>
      </div>
      <div class="card">
        <table class="grid" id="gradeGrid" aria-label="Gradebook table"></table>
      </div>
      <div class="footer">Local-only demo: data is saved in your browser's LocalStorage. For multi‑teacher or FERPA‑ready deployments, add a backend (PostgreSQL + auth) later.</div>
    </main>
  </div>

  <script>
    // --- Minimal local data layer -------------------------------------------------
    const KEY = 'opengrade_v1';
    // Storage shim: falls back to in-memory if localStorage is blocked (some previews/sandboxes)
    const storage = (()=>{ try{ const t='__og_test__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return {get:(k)=>localStorage.getItem(k), set:(k,v)=>localStorage.setItem(k,v), remove:(k)=>localStorage.removeItem(k)} } catch(e){ let mem={}; return {get:(k)=>mem[k]??null, set:(k,v)=>{mem[k]=v}, remove:(k)=>{delete mem[k]}} } })();
    const uid = () => Math.random().toString(36).slice(2,10);

    const Default = () => ({
      classes:[{id:uid(), name:'Algebra I — Period 2'}],
      selectedClassId:null,
      students:[], // {id, classId, name}
      weeks:[],    // {id, classId, label, date}
      grades:{}    // key: `${classId}|${studentId}|${weekId}` -> number
    });

    const load = () => {
      let raw = storage.get(KEY);
      if(!raw){
        const d = Default();
        d.selectedClassId = d.classes[0].id;
        // seed a couple students & weeks for demo
        const s1 = {id:uid(), classId:d.selectedClassId, name:'Ava Thompson'};
        const s2 = {id:uid(), classId:d.selectedClassId, name:'Liam Hernandez'};
        const w1 = {id:uid(), classId:d.selectedClassId, label:'Week 1', date:new Date().toISOString().slice(0,10)};
        const w2 = {id:uid(), classId:d.selectedClassId, label:'Week 2', date:new Date(Date.now()+6*86400000).toISOString().slice(0,10)};
        d.students.push(s1,s2); d.weeks.push(w1,w2);
        d.grades[`${d.selectedClassId}|${s1.id}|${w1.id}`]=95;
        d.grades[`${d.selectedClassId}|${s2.id}|${w1.id}`]=88;
        storage.set(KEY, JSON.stringify(d));
        return d;
      }
      try{ return JSON.parse(raw); }catch{ const d=Default(); storage.set(KEY, JSON.stringify(d)); return d; }
    };
    let state = load();
    const save = () => storage.set(KEY, JSON.stringify(state));

    // --- Helpers -----------------------------------------------------------------
    const getSelectedClass = () => state.classes.find(c=>c.id===state.selectedClassId) || state.classes[0];
    const studentsByClass = cid => state.students.filter(s=>s.classId===cid);
    const weeksByClass = cid => state.weeks.filter(w=>w.classId===cid);
    const getGrade = (cid,sid,wid) => state.grades[`${cid}|${sid}|${wid}`];
    const setGrade = (cid,sid,wid,val) => { state.grades[`${cid}|${sid}|${wid}`]=val; save(); };
    const delClass = (cid) => {
      state.classes = state.classes.filter(c=>c.id!==cid);
      state.students = state.students.filter(s=>s.classId!==cid);
      state.weeks = state.weeks.filter(w=>w.classId!==cid);
      for(const k of Object.keys(state.grades)) if(k.startsWith(cid+'|')) delete state.grades[k];
      if(!state.classes.length){ const d=Default(); state = d; }
      state.selectedClassId = state.classes[0].id; save();
    };

    const pctToLetter = n => {
      if(isNaN(n)) return '-';
      if(n>=90) return 'A'; if(n>=80) return 'B'; if(n>=70) return 'C'; if(n>=60) return 'D'; return 'F';
    };

    // --- UI Rendering ------------------------------------------------------------
    const el = id => document.getElementById(id);

    function renderClassList(){
      const list = el('classList'); list.innerHTML='';
      state.classes.forEach(c=>{
        const div = document.createElement('div'); div.className='class-item'+(c.id===state.selectedClassId?' active':'');
        div.innerHTML = `<div class="name">${c.name}</div>
                         <div class="row-actions">
                           <button title="Rename" data-act="rename" data-id="${c.id}">✏️</button>
                           <button title="Delete" data-act="delete" data-id="${c.id}">🗑️</button>
                         </div>`;
        div.addEventListener('click', (e)=>{
          if(e.target.dataset.act){ return; }
          state.selectedClassId=c.id; save(); renderAll();
        });
        div.querySelector('[data-act="rename"]').addEventListener('click', (e)=>{
          e.stopPropagation();
          const name = prompt('Class name:', c.name);
          if(name && name.trim()){ c.name=name.trim(); save(); renderAll(); }
        });
        div.querySelector('[data-act="delete"]').addEventListener('click', (e)=>{
          e.stopPropagation();
          if(confirm('Delete class and its data?')){ delClass(c.id); renderAll(); }
        });
        list.appendChild(div);
      });
    }

    function renderSelectedMeta(){
      const c = getSelectedClass();
      const studs = studentsByClass(c.id); const wks = weeksByClass(c.id);
      el('selectedMeta').innerHTML = `<div style="display:flex; flex-direction:column; gap:6px">
        <div><span class="muted">Class:</span> <strong>${c.name}</strong></div>
        <div><span class="muted">Students:</span> ${studs.length}</div>
        <div><span class="muted">Weeks:</span> ${wks.length}</div>
      </div>`;
      el('studentCount').textContent = `${studs.length} students`;
      el('weekCount').textContent = `${wks.length} weeks`;
    }

    function renderGrid(){
      const c = getSelectedClass();
      const studs = studentsByClass(c.id);
      const wks = weeksByClass(c.id);
      const table = el('gradeGrid');
      const headWeeks = wks.map(w=>`<th title="${w.date||''}">${w.label}</th>`).join('');
      table.innerHTML = `<thead>
        <tr><th>Student</th>${headWeeks}<th>Average</th><th>Letter</th></tr>
      </thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      const avgOf = arr => {
        const nums = arr.filter(v=>typeof v==='number' && !isNaN(v));
        if(!nums.length) return NaN;
        return nums.reduce((a,b)=>a+b,0)/nums.length;
      };

      studs.forEach(s=>{
        const row = document.createElement('tr');
        row.innerHTML = `<td style="min-width:180px; font-weight:600">${s.name}</td>`;
        const vals = [];
        wks.forEach(w=>{
          const key = `${c.id}|${s.id}|${w.id}`;
          const val = state.grades[key];
          vals.push(typeof val==='number'?val:NaN);
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type='number'; input.step='0.1'; input.min='0'; input.max='100';
          input.value = (typeof val==='number' && !isNaN(val))? val : '';
          input.placeholder='—';
          input.addEventListener('change',()=>{
            const num = input.value===''? undefined : Number(input.value);
            if(num!==undefined && (isNaN(num) || num<0 || num>100)){
              alert('Enter a number between 0 and 100, or clear the cell.'); input.select(); return;
            }
            if(num===undefined){ delete state.grades[key]; } else { setGrade(c.id,s.id,w.id,num); }
            save(); renderGrid();
          });
          td.appendChild(input); row.appendChild(td);
        });
        const avg = avgOf(vals);
        const letter = pctToLetter(avg);
        const avgTd = document.createElement('td');
        avgTd.textContent = isNaN(avg)? '—' : avg.toFixed(2)+'%';
        const letterTd = document.createElement('td');
        const span = document.createElement('span'); span.className='pill '+(letter||''); span.textContent = letter; letterTd.appendChild(span);
        row.appendChild(avgTd); row.appendChild(letterTd);
        tbody.appendChild(row);
      });

      // Summary row
      if(studs.length && wks.length){
        const footer = document.createElement('tr');
        footer.innerHTML = `<td style="font-weight:700">Class Avg</td>`;
        wks.forEach(w=>{
          const vals = studs.map(s=> getGrade(c.id,s.id,w.id)).filter(v=>typeof v==='number');
          const avg = vals.length? (vals.reduce((a,b)=>a+b,0)/vals.length) : NaN;
          const td = document.createElement('td'); td.className='muted';
          td.textContent = isNaN(avg)? '—' : avg.toFixed(1)+'%';
          footer.appendChild(td);
        });
        // class overall avg
        const perStudent = studs.map(s=>{
          const vals = wks.map(w=> getGrade(c.id,s.id,w.id)).filter(v=>typeof v==='number');
          return vals.length? (vals.reduce((a,b)=>a+b,0)/vals.length): NaN;
        }).filter(v=>!isNaN(v));
        const overall = perStudent.length? (perStudent.reduce((a,b)=>a+b,0)/perStudent.length): NaN;
        const tdAvg = document.createElement('td'); tdAvg.className='muted';
        tdAvg.textContent = isNaN(overall)? '—' : overall.toFixed(2)+'%';
        const tdLet = document.createElement('td');
        tdLet.innerHTML = `<span class="pill ${pctToLetter(overall)}">${pctToLetter(overall)}</span>`;
        footer.appendChild(tdAvg); footer.appendChild(tdLet);
        tbody.appendChild(footer);
      }
    }

    function renderAll(){ renderClassList(); renderSelectedMeta(); renderGrid(); }

    // --- Event wiring ------------------------------------------------------------
    const el = id => document.getElementById(id);
    document.getElementById('btn-add-class').addEventListener('click',()=>{
      const name = prompt('New class name (e.g., Biology — Period 3)');
      if(!name || !name.trim()) return;
      const c = {id:uid(), name:name.trim()};
      state.classes.push(c); state.selectedClassId=c.id; save(); renderAll();
    });

    document.getElementById('btn-add-student').addEventListener('click',()=>{
      const name = el('studentName').value.trim();
      if(!name){ alert('Enter the student\'s full name.'); return; }
      const c = getSelectedClass();
      state.students.push({id:uid(), classId:c.id, name});
      el('studentName').value=''; save(); renderAll();
    });

    function addWeek(){
      const label = el('weekLabel').value.trim() || `Week ${weeksByClass(getSelectedClass().id).length+1}`;
      const date = el('weekDate').value || '';
      const c = getSelectedClass();
      state.weeks.push({id:uid(), classId:c.id, label, date});
      el('weekLabel').value=''; el('weekDate').value='';
      save(); renderAll();
    }
    document.getElementById('btn-add-week').addEventListener('click', addWeek);
    document.getElementById('btn-add-week-top').addEventListener('click', addWeek);

    document.getElementById('btn-export-csv').addEventListener('click',()=>{
      const c = getSelectedClass();
      const studs = studentsByClass(c.id); const wks = weeksByClass(c.id);
      const header = ['Student', ...wks.map(w=>w.label), 'Average','Letter'];
      const rows = studs.map(s=>{
        const vals = wks.map(w=>{
          const v = getGrade(c.id,s.id,w.id);
          return (typeof v==='number' && !isNaN(v))? v.toString() : '';
        });
        // average
        const nums = vals.map(Number).filter(n=>!isNaN(n));
        const avg = nums.length? (nums.reduce((a,b)=>a+b,0)/nums.length): NaN;
        return [s.name, ...vals, isNaN(avg)? '' : avg.toFixed(2), pctToLetter(avg)];
      });
      const csv = [header, ...rows].map(r=> r.map(x=>`"${(x??'').toString().replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${c.name.replace(/[^a-z0-9]+/gi,'_')}_gradebook.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    });

    document.getElementById('btn-save-json').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='opengrade_data.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    });

    document.getElementById('import-json').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader(); reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!data || !data.classes) throw new Error('Invalid format');
          state = data; save(); renderAll(); alert('Import successful.');
        }catch(err){ alert('Could not import: '+err.message); }
      }; reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('btn-reset').addEventListener('click',()=>{
      if(confirm('Clear all local data and reset demo?')){
        storage.remove(KEY); state = load(); renderAll();
      }
    });

    // Init
    renderAll();
  </script>
</body>
</html>
